# Excel Copilot 翻訳システム仕様書

本ドキュメントは、Excel 上で稼働する翻訳支援アプリケーションの最新構成と挙動をまとめたものです。現在はフォーム経由でリクエストを受け付けるタブ構成の UI を標準とし、従来の自由入力チャットは結果タイムライン兼ログビューとして提供されています。

## 目的と機能

- Excel の指定セル範囲を日本語から英語（他言語にも拡張可能）へ翻訳する。
- 参照資料（リモート URL）を活用し、訳語の統一と証跡を補強する。
- 既存翻訳の品質レビューを行い、指摘内容・修正案・ハイライトを提示する。
- 翻訳結果やレビュー結果を Excel に書き戻し、進捗を UI 上で可視化する。

## アーキテクチャ概要

| レイヤー | 役割 | 主なモジュール |
| --- | --- | --- |
| デスクトップ UI (Flet) | 左ペイン（接続ステータス／コンテキスト概要／共通アクション）とメインペイン（タブ型フォーム＋チャットタイムライン）を構成し、ユーザー入力をキューへ送信する。モード選択はフォーム内タブで完結し、チャットタイムラインにはユーザーの送信内容と AI の最終回答のみを時系列で表示する。 | `desktop_app.py`, `excel_copilot/ui/chat.py`, `excel_copilot/ui/theme.py` |
| ワーカースレッド | Playwright 経由で Copilot セッションを維持し、フォームで受け取った構造化リクエストをツールへ橋渡しする。 | `excel_copilot/ui/worker.py`, `excel_copilot/ui/messages.py` |
| ツール層 | 翻訳・レビューなどの Excel 操作を実装し、Copilot とのプロンプト往復を担う。 | `excel_copilot/tools/excel_tools.py`, `excel_copilot/tools/actions.py` |
| コアサービス | Excel 接続（xlwings）と Copilot ブラウザ自動化（Playwright）、共通例外と設定。 | `excel_copilot/core/excel_manager.py`, `excel_copilot/core/browser_copilot_manager.py`, `excel_copilot/core/exceptions.py`, `excel_copilot/config.py` |

## 実行フロー（フォーム版）

1. **アプリ起動（`desktop_app.py`）**  
   Flet アプリを初期化し、`CopilotWorker` をバックグラウンド起動する。チャット履歴とフォーム UI を構築し、初期状態を READY に設定する。
2. **ワーカー初期化（`CopilotWorker._initialize`）**  
   `BrowserCopilotManager` を起動して Copilot Web チャットへ接続し、モードに応じたツール関数を読み込む。初期化完了までステータスメッセージを UI に通知する。
3. **フォーム送信（`CopilotApp._submit_form`）**  
   タブ型フォーム（モード／対象範囲／出力設定／参考資料／オプション）で必須入力・数値範囲・参照 URL を検証し、モード・ツール名・引数から成る JSON ペイロードを `RequestQueue` へ投入する。翻訳モードでは原文／訳文向けの参照 URL（各 1 件まで）のみを受け付け、共通参照・引用出力・バッチ行数といった旧フィールドは扱わない。サマリーにはモード名／ブック／シートを付与し、フォーム下部のアクションバーにはプログレスリング・停止・続けて実行ボタンを配置する。
4. **構造化タスク実行（`CopilotWorker._run_structured_task`）**  
   ペイロードを検証し、対象ブック／シート・引数を整えて該当ツールを実行する。進捗メッセージや最終結果を UI に返却する。
5. **Excel 書き戻し**  
   ツール層が Copilot 応答をもとに Excel を更新し、その結果メッセージをワーカー経由で UI に返す。レビュー系タスクではフォームで指定された `highlight_output_range` に差分ハイライトを描画し、リッチテキスト非対応環境ではマーカー付きテキストにフォールバックする。停止要求があった場合は途中で処理を中断し、ブラウザセッションをリセットする。
6. **UI 更新と終了処理**  
   Final Answer をチャットログに追加し、タスク状態を READY へ戻す。停止／送信ボタン群やモードタブの状態を現在のステータスに合わせて更新し、「続けて実行」ボタンを有効化して次タスク着手を容易にする。またチャットフィルターに応じてタイムラインを再描画し、最新メッセージへのスクロール操作を提供する。

## 差分ハイライト

- レビュー用ツール（`check_translation_quality`）は AI 応答に含まれる `[ADD]...` と `[DEL]...` マーカーからセル単位の差分スパンを生成し、`highlight_output_range` に最新訳文を下敷きとして書き戻す。
- `ExcelActions.apply_diff_highlight_colors` が加筆箇所を青（`#1565C0`）、削除箇所を赤（`#C62828`）でセル内文字に着色し、プラットフォームがリッチテキスト非対応の場合はマーカーのみを残す。
- `highlight_text_differences` ユーティリティを使うことで、任意の 2 範囲間でも同等のハイライトを生成でき、レビュー以外のシナリオでも視覚的フィードバックを提供できる。

## UI コンポーネント概要

- **ステータスカード**: READY／処理中／停止／エラーに応じてアイコンとカラーリングを切り替え、初回起動からのステータスメッセージを表示する。  
- **コンテキストカード**: 選択中のブック・シート・最終同期時刻を表示し、ドロップダウンによる変更を受け付ける。  
- **アクションカード**: ブック一覧の更新と新規チャットリセットを集約し、状態に応じてボタンを活性／非活性化する。  
- **チャットタイムライン**: ユーザーが送信した内容と AI の最終回答のみをタイムスタンプ付きで表示する、シンプルなログビュー。結果がない場合は手順ガイド付きの空状態カードを表示する。  
- **タブ型フォーム**: モード／対象範囲／出力設定／参考資料／オプションのタブで構成し、Required バッジと入力サマリーを表示する。参考資料では各種 URL を 1 件まで入力できるシンプルなフィールドを提供する。  
- **アクションバー**: プログレスリングとステップメッセージ、停止、送信をまとめ、タスクライフサイクルに応じて表示状態を切り替える。

## 今後の改善候補

- フォーム定義を外部 JSON 等へ切り出し、モード追加やフィールド変更をコード修正なしで行えるようにする。
- フォーム入力と Excel 書き戻しを対象とした自動テストを整備し、回帰検証の確実性を高める。
- 参照資料の入力 UX を改善し、ドラッグ＆ドロップや最近使用したリンクの候補表示を追加検討する。
