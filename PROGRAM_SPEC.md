# Excel Copilot 翻訳システム仕様書

本書は Excel 上で動作する翻訳アシスタントの構成と挙動を新規参加者向けに説明します。コード全体を読まなくても主要コンポーネントの関係が把握できるようにしています。

## 目的と機能

- Excel のセル範囲を日本語から英語（他言語にも拡張可能）へ自動翻訳する。  
- 参照資料（用語集やバイリンガルドキュメント）を活用し、統一された訳語を維持する。  
- 既存訳の品質レビューを実施し、指摘・修正文・ハイライト情報を返す。  
- プロセスメモや引用情報などの補足列を整えた状態で Excel に書き戻す。  

## アーキテクチャ概要

| レイヤー | 役割 | 主なモジュール |
| --- | --- | --- |
| デスクトップ UI (Flet) | チャットパネルとフォーム UI を提供する。ユーザー入力を収集し、進捗や最終結果を表示する。 | `desktop_app.py`, `excel_copilot/ui/chat.py`, `excel_copilot/ui/theme.py` |
| フォームコンポーネント | モード別の入力欄（セル範囲、出力列、参照 URL など）を持ち、送信時に内部で JSON ペイロードを構築する。 | `desktop_app.py`（UI 定義部分）, `excel_copilot/ui/forms.py` *（追加予定）* |
| ワーカースレッド | Playwright を起動し、Copilot セッションを維持する。モードに応じたツール関数を直接呼び出し、結果をレスポンスキューへ送る。 | `excel_copilot/ui/worker.py`, `excel_copilot/ui/messages.py` |
| エージェント層（軽量） | 共通のシステムプロンプトや最終メッセージ整形が必要な場合に利用する。ReAct ループは後方互換モードとして残るのみ。 | `excel_copilot/agent/prompts.py` |
| ツール層 | 翻訳／レビューなどの実処理を実装。ExcelActions 経由で Excel を操作し、Copilot へ送るプロンプトを構築する。 | `excel_copilot/tools/excel_tools.py`, `excel_copilot/tools/actions.py` |
| コアサービス | Excel 接続（xlwings）と Copilot ブラウザ自動化（Playwright）を提供。例外処理や設定もここに集約。 | `excel_copilot/core/excel_manager.py`, `excel_copilot/core/browser_copilot_manager.py`, `excel_copilot/core/exceptions.py`, `excel_copilot/config.py` |

翻訳ツールは共通の `BrowserCopilotManager` を通じて Microsoft 365 Copilot にプロンプトを送信し、Excel 操作は `ExcelActions` が担当します。

## 実行フロー

1. **アプリ起動（`desktop_app.py`）**  
   - Flet アプリを初期化し、キューを生成して `CopilotWorker` をバックグラウンドで起動。  
   - モードカードと入力フォームを描画し、フォーム入力とチャット入力の双方を受け付ける。  

2. **ワーカー初期化（`CopilotWorker._initialize`）**  
   - `BrowserCopilotManager` を立ち上げ、Copilot チャットページへ接続。  
   - 現在のモードで利用可能なツール関数を読み込み、事前計算が必要なプロンプト断片を準備。  
   - フォームが送信されても即座に処理できるよう、状態を UI へ通知。  

3. **リクエスト処理（`CopilotWorker._main_loop`）**  
   - `USER_INPUT` リクエストは JSON ペイロードとして受け取り、モードに対応するツールを直接呼び出す。  
   - フォームが未設定の場合や自由形式入力の場合は、必要に応じてレガシー ReAct フローへ切り替える。  
   - `STOP`／`RESET_BROWSER`／`UPDATE_CONTEXT` は従来通りキャンセルや再接続を担当。  

4. **ツール実行（`excel_copilot/tools/*.py`）**  
   - Excel からデータを取得し、Copilot へ送信するプロンプトを組み立てる。  
   - 応答の JSON を検証し、Excel に書き戻す。  
   - 人が読める要約を返し、ワーカーが最終メッセージとして UI に転送。  

5. **UI 表示**  
   - 進捗や警告はステータスメッセージとしてチャット欄に表示。  
   - 最終メッセージはフォーム送信時の設定とともに一覧で確認できる。  

## 対応モードとフォーム項目

### 翻訳（参照なし）

| 項目 | 説明 |
| --- | --- |
| ソース範囲 | 翻訳元セル範囲（例: `A2:A20`） |
| 出力範囲 | 翻訳結果を書き込む列（例: `B2:B20`） |
| ターゲット言語 | 既定は English。必要に応じて変更可能。 |
| バッチ行数 | 大きな範囲を複数回に分割する場合に指定。 |

### 翻訳（参照あり）

| 項目 | 説明 |
| --- | --- |
| ソース範囲 | 翻訳元セル範囲 |
| 出力範囲 | 翻訳結果／プロセスメモ／参照ペアなどの開始列 |
| 参照 URL / ファイル | 原文／訳文の参照リスト。複数可。フォームでは行追加で入力できる。 |
| 引用出力範囲 | 引用情報を書き込むセル範囲（任意）。 |
| ターゲット言語 / バッチ設定 | 上記に同じ。 |

### 翻訳レビュー

| 項目 | 説明 |
| --- | --- |
| 原文範囲 | 日本語原文の列 |
| 翻訳範囲 | レビュー対象の英語列 |
| ステータス列 | `OK/REVISE` を書き込む列 |
| 指摘列 | Issue/Suggestion を書き込む列 |
| ハイライト列 | 差分ハイライトを出力する列 |
| 修正列 | （任意）修正文を別列に出したい場合の列 |

フォーム送信時、これらの値から JSON ペイロードを自動生成し、ワーカーへ渡します。ユーザーがチャット欄に自由入力した場合でも引き続き利用可能です。

## フォーム送信からツール実行までの詳細

1. ユーザーがフォームに値を入力し「送信」を押す。  
2. UI がモード別のバリデーションを行い、不足項目があれば即座にエラー表示。  
3. 問題なければ、フォーム値を JSON オブジェクトへ整形し、`RequestMessage(USER_INPUT)` に添付。  
4. ワーカーが JSON を受け取り、モードに対応するツール関数を選択。  
5. 既定で `ExcelActions`、`browser_manager`、`sheet_name`、`stop_event` が引数に注入される。  
6. ツールが Copilot とやり取りし、結果を Excel に書き戻す。進捗メッセージは `progress_callback` で UI にストリーミング。  
7. 最終結果またはエラーを `ResponseMessage` として UI へ返却。  

## エラー処理とキャンセル

- 形式エラー（セル範囲未指定など）はフォーム側でブロックし、メッセージを表示。  
- ツール実行中の例外は `ToolExecutionError` として UI に通知。必要に応じてフォーム値を修正して再送できる。  
- ユーザーがキャンセルした場合は `stop_event` がセットされ、ツール側でも早期終了しブラウザセッションをリセットする。  

## 貢献者向けメモ

- `desktop_app.py` でフォーム定義を行う予定。共通バリデーションロジックは `ui/forms.py` に切り出す。  
- フォームのバリデーションルールはモードごとにテストを書き、必須項目が欠けた際のエラーメッセージが明確か確認する。  
- 既存チャット入力との併用時に齟齬が出ないよう、ワーカー側の後方互換コードを暫定的に維持する。  
- 実装後は翻訳／参照付き翻訳／レビューのフォーム送信と、自由入力によるレガシーフローの両方で動作確認を行う。  

この設計により、ユーザーは JSON を直接記述する必要がなく、フォーム入力のみで確実に必要項目を揃えたリクエストを実行できます。一方で特殊なケースでは引き続き自由入力からの ReAct フローも利用できるため柔軟性も確保しています。
