# 実装計画メモ

## 完了した項目

1. フォーム UI の刷新  
   - 従来の自由入力チャットを閲覧専用に変更し、モードに応じた入力フィールドを定義しました。  
   - クライアント側で必須入力や数値範囲を検証し、その場でエラーメッセージを表示できるようにしました。  
   - 送信内容から構造化 JSON ペイロードを生成し、ワーカーへ投入する経路を整備しました。  
   - 現行プロセスで不要となった「共通参照URL／ファイル」「引用出力範囲」「バッチ行数」の入力フィールドを削除し、フォームを簡素化しました。  
   - 参照資料入力は専用セクションに整理し、オプション項目を視覚的にまとめて入力負荷を軽減しました。  
   - 参照フィールドはリモート URL のみを受け付ける方針に統一し、文言・バリデーションを順次見直す予定です。
2. チャット表示と操作系の整理  
   - 送信ボタンを廃止してフォーム内の「送信」「停止」操作に統合しました。  
   - 自動テスト経路をフォーム送信フローに合わせて更新しました。  
   - 直近入力値を保持したままフォームを再描画できるようにしました。
3. ワーカー処理の単純化  
   - ReAct ベースのレガシー処理を撤廃し、構造化タスクのみを受け付けるよう統一しました。  
   - フォーム固有フィールド（`sheet_name` など）の受け渡しと検証を整理しました。  
   - Excel／Copilot 由来の例外を UI に伝達できるようエラーハンドリングを強化しました。
4. ドキュメント整備  
   - `PROGRAM_SPEC.md` をフォーム運用前提の内容に更新しました。  
   - 本メモを最新の段取りに合わせて再整理しました。
5. UI オーバーホール  
   - 左ペインをステータス／コンテキスト概要／共通アクションの 3 カードに分割し、最終同期時刻やブック／シート状態を即時把握できるようにしました。  
   - チャットタイムラインにフィルターと空状態カードを追加し、タスク完了バッジやタイムスタンプを含むメタ情報を表示するようにしました。  
   - フォームをタブ型レイアウトへ刷新し、モード選択カードをタブ内に統合。必須項目バッジ・参考 URL フィールドの簡素化・進行状況リングと「続けて実行」導線も実装しました。  
   - 送信 summary にモード・ブック／シートを添付し、進捗メッセージと連動するフォーム下部のステータス表示を追加しました。  
   - フォームとチャットをレスポンシブな 2 カラムに配置し、フォーム高さを固定スクロールにすることでチャットが常に視界に残るようにしました。  
   - チャットログ保存ボタンとモード切替時の自動メッセージを廃止し、ノイズの少ないタイムラインに整理しました。  

## 次フェーズで引き継ぐタスク

- 代表的なフォーム入力ケースについて自動テスト（単体／統合）を追加し、回帰検証を容易にする。  
- フォーム定義やデフォルト値を外部設定化し、運用環境ごとにカスタマイズしやすくする。  
- 参照資料（URL）入力の UX をさらに強化し、ドラッグ＆ドロップ／最近使用候補／貼り付けテキストの URL バリデーションを追加検討する。  
- UI のラベル／プレースホルダー文言と実装仕様（複数参照の扱い、ローカルファイル可否など）の差異を棚卸しし、必要に応じて文言・バリデーションを調整する。  
- ステータスチップやチャットフィルターのレスポンシブ挙動を確認し、タブレット解像度での sticky 化・高さ調整を検討する。

## 既知不具合の調査計画

- フォーム送信ボタン押下時に反応がない事象を最優先で再現し、ハンドラー `_submit_form` が呼び出されているか、`AppState` 判定によって早期リターンしていないかをログで確認する。  
- `_collect_form_payload` のバリデーション結果とエラーメッセージが UI へ適切に表示されるかを検証し、入力エラー時の可視化を強化する。  
- `RequestQueue` への投入が行われているか、`CopilotWorker` の受信ループが停止／例外で脱落していないかをスレッドログで確認する。  
- 送信ボタンの UI 状態（活性／非活性）とページ更新タイミングを見直し、Flet のイベントルーティングで on_click が握り潰される条件を調査する。  
- 再発防止として、送信ボタン押下から `RequestType.USER_INPUT` 生成までをカバーする結合テスト／自動リグレッションチェックを追加する。

## 不具合調査結果

- `_submit_form` 自体はボタン押下で呼び出されるが、`_collect_form_payload` 内で参照している `FORM_TOOL_NAMES` が未定義のため `NameError` が発生し、例外が Flet イベントループに伝播して UI が無反応に見えていた（desktop_app.py:1213）。  
- バリデーション処理や `RequestQueue` への投入には到達しておらず、ワーカーにタスクが渡らないためチャットタイムラインやステータスも更新されないことを確認。  
- `_set_form_error` の可視化や AppState の遷移ロジックは想定通り働いており、定数欠落が唯一のブロッカーであると判断した。

## 修正計画

- `FORM_TOOL_NAMES` をフォーム定義付近に追加し、各モードとツール名（`translate_range_without_references`／`translate_range_with_references`／`check_translation_quality`）を紐付ける。  
- `FORM_TOOL_NAMES.get(...)` が失敗した際に UI 側で例外が露出しないよう、防御的にログ出力とユーザー向けエラーメッセージを保持する。  
- `_collect_form_payload` の単体テストを追加し、各モードで期待するツール名と引数が生成されること、および参照 URL 未入力時にエラーを返すことを自動検証する。  
- フォーム送信の結合テスト（モックキューを使用）を用意し、送信ボタン押下で `RequestType.USER_INPUT` がキューに投入されることを継続的に確認する。

## 修正結果

- `desktop_app.py` に `FORM_TOOL_NAMES` を新設し、送信モードからツール名を解決できるようにしたうえで、未定義モード検出時に `logging.error` を記録してユーザー向けメッセージを維持するよう更新した。  
- 単体テスト `tests/test_form_payload.py` を追加し、翻訳・参照付き翻訳・レビュー各モードでの引数生成と検証エラー挙動を `python -m unittest discover -s tests` で確認できるようにした。  
- レビューモードの出力フィールドを1つの「出力範囲」入力に統合し、指定レンジからステータス／指摘／ハイライト／修正案列を動的に算出するヘルパーを `desktop_app.py` に追加。タブ UI の表示とフォームサマリーも統合レンジに合わせて更新した。  
- 統合レンジが 3 列（修正案なし）または 4 列（修正案あり）で入力された場合の挙動をテストでカバーし、異常系ではユーザーにわかりやすいエラーメッセージを返すようバリデーションを強化した。  
- 結合テストについては Worker モックを含むシナリオ化が大規模なため、別タスクとして追跡する。

## UI 改善計画（スクリーンショット確認ベース）

- 左ペインのカードを「接続ステータス」「対象ブック／シート」「共通アクション」の 3 ブロックに分割（実装済み）。最終同期時刻と READY／処理中の配色が反映されているが、横幅が狭い場合の sticky 化と警告色のメリハリは追加検討事項。  
- チャットタイムラインに空状態カード・フィルター・「最新の結果へ」ボタン・モードバッジ／タイムスタンプを導入済み。巨大ログ時の仮想化やフィルター種別の拡張が今後の検討課題。  
- フォーム入力セクションはタブ化し、「対象範囲」「出力設定」「参考資料」「オプション」に分割して Required バッジ／サマリー表示を実装済み。タブ一括エラー表示やタブごとの未入力ハイライトが今後の改善余地。  
- 参考資料エリアは単一 URL を入力するシンプルなフィールドに揃え、余分なボタンを排除した。複数参照が必要な場合のワークフロー整備は別途検討事項。  
- モードカードはフォーム内タブに統合済み。今後はタブ名称・説明文の改善とヘルプリンクの追加を検討する。  
- チャットログ保存操作は廃止済み。必要に応じてエクスポート手段を別途提供するか検討する。  
- 送信／停止ボタンはフォーム下部のアクションバーに固定し、進行中のプログレスリングとステップメッセージ、「続けて実行」ボタンを追加済み。ステップ名称の粒度調整とタスク失敗時の再送導線が次の検討事項。
