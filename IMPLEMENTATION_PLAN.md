# 実装計画メモ

## 完了した項目

1. フォーム UI の刷新  
   - 従来の自由入力チャットを閲覧専用に変更し、モードに応じた入力フィールドを定義しました。  
   - クライアント側で必須入力や数値範囲を検証し、その場でエラーメッセージを表示できるようにしました。  
   - 送信内容から構造化 JSON ペイロードを生成し、ワーカーへ投入する経路を整備しました。  
   - 現行プロセスで不要となった「共通参照URL／ファイル」「引用出力範囲」「バッチ行数」の入力フィールドを削除し、フォームを簡素化しました。  
   - 参照資料入力は専用セクションに整理し、オプション項目を視覚的にまとめて入力負荷を軽減しました。  
   - 参照フィールドはリモート URL のみを受け付ける方針に統一し、文言・バリデーションを順次見直す予定です。
2. チャット表示と操作系の整理  
   - 送信ボタンを廃止してフォーム内の「送信」「停止」操作に統合しました。  
   - 自動テスト経路をフォーム送信フローに合わせて更新しました。  
   - 直近入力値を保持したままフォームを再描画できるようにしました。
3. ワーカー処理の単純化  
   - ReAct ベースのレガシー処理を撤廃し、構造化タスクのみを受け付けるよう統一しました。  
   - フォーム固有フィールド（`sheet_name` など）の受け渡しと検証を整理しました。  
   - Excel／Copilot 由来の例外を UI に伝達できるようエラーハンドリングを強化しました。
4. ドキュメント整備  
   - `PROGRAM_SPEC.md` をフォーム運用前提の内容に更新しました。  
   - 本メモを最新の段取りに合わせて再整理しました。
5. UI オーバーホール  
   - 左ペインをステータス／コンテキスト概要／共通アクションの 3 カードに分割し、最終同期時刻やブック／シート状態を即時把握できるようにしました。  
   - チャットタイムラインにフィルターと空状態カードを追加し、タスク完了バッジやタイムスタンプを含むメタ情報を表示するようにしました。  
   - フォームをタブ型レイアウトへ刷新し、必須項目バッジ・参考 URL の追加／削除／貼り付けショートカット・進行状況リングと「続けて実行」導線を実装しました。  
   - 送信 summary にモード・ブック／シートを添付し、進捗メッセージと連動するフォーム下部のステータス表示を追加しました。  

## 次フェーズで引き継ぐタスク

- 代表的なフォーム入力ケースについて自動テスト（単体／統合）を追加し、回帰検証を容易にする。  
- フォーム定義やデフォルト値を外部設定化し、運用環境ごとにカスタマイズしやすくする。  
- 参照資料（URL）入力の UX をさらに強化し、ドラッグ＆ドロップ／最近使用候補／貼り付けテキストの URL バリデーションを追加検討する。  
- UI のラベル／プレースホルダー文言と実装仕様（複数参照の扱い、ローカルファイル可否など）の差異を棚卸しし、必要に応じて文言・バリデーションを調整する。  
- ステータスチップやチャットフィルターのレスポンシブ挙動を確認し、タブレット解像度での sticky 化・高さ調整を検討する。


## UI 改善計画（スクリーンショット確認ベース）

- 左ペインのカードを「接続ステータス」「対象ブック／シート」「共通アクション」の 3 ブロックに分割（実装済み）。最終同期時刻と READY／処理中の配色が反映されているが、横幅が狭い場合の sticky 化と警告色のメリハリは追加検討事項。  
- チャットタイムラインに空状態カード・フィルター・「最新の結果へ」ボタン・モードバッジ／タイムスタンプを導入済み。巨大ログ時の仮想化やフィルター種別の拡張が今後の検討課題。  
- フォーム入力セクションはタブ化し、「対象範囲」「出力設定」「参考資料」「オプション」に分割して Required バッジ／サマリー表示を実装済み。タブ一括エラー表示やタブごとの未入力ハイライトが今後の改善余地。  
- 参考資料エリアでは URL 行の追加・削除・クリップボード貼り付けが可能になった。貼り付け時の URL 正規化（余分なテキストの除去）とドラッグ＆ドロップ対応を次候補として残す。  
- 送信／停止ボタンはフォーム下部のアクションバーに固定し、進行中のプログレスリングとステップメッセージ、「続けて実行」ボタンを追加済み。ステップ名称の粒度調整とタスク失敗時の再送導線が次の検討事項。
